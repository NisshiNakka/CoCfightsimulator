<div class="container">
  <h1>Cthulhu 7th ダイスロール</h1>
  
  <%= form_with url: roll_path, method: :post, data: { turbo: true } do |f| %>
    <div class="form-group">
      <%= f.label :command, "ダイスコマンド" %>
      <%= f.text_field :command, 
          placeholder: "例: CC<=50 (技能値50でロール)", 
          class: "form-control",
          autofocus: true %>
      <small class="form-text text-muted">
        例: CC<=70 (技能判定), 1D100 (D100を振る), 3D6 (D6を3個振る)
      </small>
    </div>
    
    <%= f.submit "ロール", class: "btn btn-primary" %>
  <% end %>

  <% if @ally_character %>
    <div class="mt-3 p-3 border rounded bg-light">
      <h5><%= @ally_character.name %> のクイックアクション</h5>
      <%= button_to "回避ロールを実行 (値:#{@ally_character.evasion_rate})", 
            roll_path, 
            params: { command: "CC<=#{@ally_character.evasion_rate}" }, 
            method: :post, 
            class: "btn btn-outline-primary",
            data: { turbo_stream: true } %>
    </div>
  <% end %>
  <% if @enemy_character %>
    <div class="mt-3 p-3 border rounded bg-light">
      <h5><%= @enemy_character.name %> のクイックアクション</h5>
      <%= button_to "回避ロールを実行 (値:#{@enemy_character.evasion_rate})", 
            roll_path, 
            params: { command: "CC<=#{@enemy_character.evasion_rate}" }, 
            method: :post, 
            class: "btn btn-outline-primary",
            data: { turbo_stream: true } %>
    </div>
  <% end %>
  <% if @ally_character && @enemy_character %>
    <div class="mt-3 p-3 border rounded bg-light">
      <% @ally_character.attacks.each do |attack| %>
        <%= button_to "#{attack.name}で攻撃 (値:#{attack.success_probability})", 
              combat_roll_path,
              params: { skill_value: attack.success_probability, skill_correction: attack.dice_correction, attacker_side: "ally" }, 
              method: :post, 
              class: "btn btn-outline-danger",
              data: { turbo_stream: true } %>
      <% end %>
    </div>
    <div class="mt-3 p-3 border rounded bg-light">
      <% @enemy_character.attacks.each do |attack| %>
        <%= button_to "#{attack.name}で攻撃 (値:#{attack.success_probability})", 
              combat_roll_path,
              params: { skill_value: attack.success_probability, skill_correction: attack.dice_correction, attacker_side: "enemy" }, 
              method: :post, 
              class: "btn btn-outline-danger",
              data: { turbo_stream: true } %>
      <% end %>
    </div>
  <% else %>
    <p class="mb-0"><%= t('.select_character_instruction') %></p>
  <% end %>

  <div id="dice_result", class="result-area mt-4">
    <!-- ここに結果が表示されます -->
  </div>
</div>